datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

generator client {
    provider = "prisma-client-js"
}

enum RunnerType {
    PLEASURE
    PROGRESS
    COMPETITOR
}

enum CoachPersonality {
    COOL
    MODERATE
    COMPET
}

enum ValueSource {
    ESTIMATED
    USER
}

enum UnitSource {
    METRIC
    IMPERIAL
}

enum MetricSource {
    VMA
    FC_REPOS
    FC_MAX
    FC_RESERVE
    HRR_ZONES
    VMA_ZONES
}

enum HeartSource {
    HRR
    FC_MAX
}

enum ActivityType {
    EF
    EA
    SEUIL
    VMA
    INDOOR
}

enum IntervalRun {
    DEMICOOPER
    COOPER
}

enum Provider {
    STRAVA
    GARMIN
    COROS
    POLAR
    SUUNTO
    APPLE_HEALTH
    GOOGLE_HEALTH
}

enum SyncStatus {
    IDLE
    RUNNING
    FAILED
    COMPLETED
}

enum Gender {
    MALE
    FEMALE
    OTHER
}

model ProviderAccount {
    id                String    @id @default(cuid())
    userId            String
    provider          Provider
    providerUserId    String // ex: athleteId Strava, userId Garmin...
    scope             String? // scopes OAuth (ex: "activity:read_all,profile:read_all")
    isPremium         Boolean?
    isActive          Boolean?
    hasHeartRateData  Boolean?  @default(false)
    heartRateCoverage Float?
    heartRateStatus   String?
    accessToken       String?
    refreshToken      String?
    expiresAt         DateTime?
    profile           Json? // dump du profil provider (facultatif)
    createdAt         DateTime  @default(now())
    updatedAt         DateTime  @updatedAt

    user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
    activities Activity[]

    @@unique([provider, providerUserId])
    @@index([userId, provider])
}

model SyncCursor {
    id           String     @id @default(cuid())
    userId       String
    provider     Provider
    status       SyncStatus @default(IDLE)
    cursor       String? // pagination key / webhook state
    since        DateTime? // point de départ (backfill)
    lastSyncedAt DateTime?
    error        String?
    meta         Json?

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([userId, provider])
}

model SyncLog {
    id        String   @id @default(cuid())
    userId    String
    provider  Provider
    level     String // INFO|WARN|ERROR
    message   String
    context   Json?
    createdAt DateTime @default(now())

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId, provider, createdAt])
}

model User {
    id        String   @id @default(cuid())
    userName  String
    firstName String?
    lastName  String?
    weight    Int?
    email     String
    password  String
    gender    Gender
    birthDay  DateTime

    measurementUnit UnitSource  @default(METRIC)
    heartUnit       HeartSource @default(HRR)

    runnerType       RunnerType?      @default(PLEASURE)
    coachPersonality CoachPersonality @default(MODERATE)

    age Int?

    lastSyncedAt   DateTime?
    lastActivityAt DateTime?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    activities       Activity[]
    WeeklyFeatures   WeeklyFeatures[]
    physioHistory    PhysioHistory[]
    providerAccounts ProviderAccount[]
    syncCursors      SyncCursor[]
    syncLogs         SyncLog[]

    @@unique([email])
}

model PhysioHistory {
    id     String @id @default(cuid())
    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    metric MetricSource
    value  Decimal
    source ValueSource

    windowStart DateTime?
    windowEnd   DateTime?
    runsCount   Int?
    note        String?
    payload     Json?

    createdAt DateTime @default(now())

    @@index([userId, metric, createdAt])
}

model Activity {
    id     String @id @default(cuid())
    userId String

    provider   Provider
    externalId String

    accountId String?
    account   ProviderAccount? @relation(fields: [accountId], references: [id], onDelete: SetNull)

    dateUtc     DateTime
    dateLocal   DateTime
    distanceM   Int
    movingTimeS Int
    elevGainM   Int
    sport       String
    avgHr       Int?
    maxHr       Int?
    avgCadSpm   Int?
    avgPaceSpKm Int?
    hrZone      String?

    load                Float?
    type                ActivityType?
    createdAt           DateTime              @default(now())
    user                User                  @relation(fields: [userId], references: [id])
    ActivityRollingBest ActivityRollingBest[]

    @@unique([userId, provider, externalId])
    @@index([userId, dateUtc])
}

model ActivityRollingBest {
    id String @id @default(cuid())

    // relations
    activityId String
    activity   Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
    userId     String

    // Fenêtre 360 s (6')
    startOffsetS360 Int?
    endOffsetS360   Int?
    distanceM360    Int?
    speedMps360     Decimal?
    avgHr360        Int?
    dPlusM360       Int?

    // Fenêtre 720 s (12')
    startOffsetS720 Int?
    endOffsetS720   Int?
    distanceM720    Int?
    speedMps720     Decimal?
    avgHr720        Int?
    dPlusM720       Int?

    averageSpeedMps Decimal?
    averageSpeedKmh Decimal?

    createdAt DateTime @default(now())

    @@index([userId])
    @@index([activityId])
}

model WeeklyFeatures {
    id         String   @id @default(cuid())
    userId     String
    year       Int // ex: 2025
    weekNumber Int // ex: 2
    weekStart  DateTime // Lundi 00:00:00 (UTC)

    runsCount   Int
    daysActive  Int
    distanceKm  Float
    movingTimeH Float
    elevGainM   Int

    loadWeek   Float // Σ load
    monotony   Float? // mean(dayLoads)/std(dayLoads)
    strain     Float? // loadWeek * monotony
    acwr       Float? // loadWeek / mean(loadWeek des 4 sem précédentes)
    maxDayLoad Float? // AU
    max48hLoad Float?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    user User @relation(fields: [userId], references: [id])

    @@unique([userId, year, weekNumber])
    @@index([userId, weekStart])
}
